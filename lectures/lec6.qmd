---
title: Algebraic and Semi-Algebraic Reasoning For Formal Methods
subtitle: Lecture 6 -  Positivstellensatz and Applications.
author: Sriram Sankaranarayanan
# format:
#   revealjs:
#     theme: serif
#     center: true
#     transition: slide
#     incremental: false
#     slide-number: c/t
#     pdf-separate-fragments: true
#     html-math-method:
#       method: mathjax
format:
  beamer: 
    navigation: horizontal
    theme: metropolis
---


## Proving Entailments
 
\renewcommand\Re{\mathbb{R}}

  $$ (\forall x, y \in \mathbb{R}) \quad x^2 + y^2 \leq 1  \ \land\ x + y \leq 0 \ \Rightarrow\  y \leq 1.423  $$

Why?

$$(1.423 - y) = \left( \begin{array}{c} 0.765134 \ \  (1-x^2-y^2)\ + \\ 
0.4 \ \   -(x+y)\ + \\ 
0.6574 - 0.6 x + 0.4 y + 0.765134 (x^2 + y^2)\\
\end{array} \right)
$$



## Positivstellensatz 

Consider entailment over $\Re^n$:

$$p_1 \geq 0 \ \land\ \cdots \ \land\ p_m \geq  0\ \models\ p \geq 0$$

- One approach is to try to convert to real Nullstellensatz.

## Inequalities to Equalities

Consider polynomials over $p \in \Re[x_1, \ldots, x_n]$.
 
 - Let $t$ be a fresh variable.

 - $p \geq 0 \ \Leftrightarrow\ p = t^2$
 - $p > 0\ \Leftrightarrow\ t^2 p = 1$
 - $p \not= 0 \ \Leftrightarrow\ t p = 1$

Convert entailment back to equalities.

## Real Varieties

Given $p_1, \ldots, p_m \in \Re[x_1, \ldots, x_n]$, define the _real variety_ as 

$$V = \{ \vec{x} \in \Re^n\ |\ \bigwedge_{j=1}^m p_j = 0 \}$$

- We already saw the importance of algebraic closure.
  - Real variety of $1 + x^2 = 0$.

__Theorem__ $V=\emptyset$ if and only if $1 + \sigma \in \langle p_1, \ldots, p_m \rangle$, where $\sigma$ is SOS. 

## Positivestellensatz 

Let $S = \{ \vec{x} \in \Re^n\ |\ p_1(\vec{x}) \geq 0\ \land\ \cdots\ \land\ p_m(\vec{x}) \geq 0 \}$.

 - We wish to show that $p \geq 0$ on $S$ for given $p$.

 - __Important:__ We will need $S$ to be compact.

## Schmugden's Positivstellensatz

Enrich the set of polynomials

$$ Q(S) = \{ p_1^{e_1} \cdots p_m^{e_m}\ |\ e_i \in \{0, 1\} \} $$ 

__Note:__ $|Q(S)| = 2^m$.

__Theorem (Schmugden'1991)__  

  - If $p = \sum_{q \in Q(S)} \sigma_q q$ for $\sigma_q$  SOS then $p_1(\vec{x}) \geq 0\ \land\ \cdots\ \land\ p_m(\vec{x}) \geq 0 \models p \geq 0$.
  - Conversely, if $p_1(\vec{x}) \geq 0\ \land\ \cdots\ \land\ p_m(\vec{x}) \geq 0 \models p > 0$  
  then $p = \sum_{q \in Q(S)} \sigma_q q$ for $\sigma_q$  SOS.


## Putinar's Positivstellensatz 

Let $M = \{ \sum_{j=1}^m \sigma_j p_j + \sigma_0\ |\ \sigma_0, \ldots, \sigma_m\ \text{SOS} \}$.

- $M$ is called the _quadratic module_ generated by $p_1, \ldots, p_m$.

- __Archimedean Property:__ There exists a $K$ such that 
$$ K - (x_1^2 + \cdots + x_n^2)  \in M $$ 

 - Explain connection to Archimedes in lecture.


__Theorem (Putinar'1993)__ 
  
   - If $p \in M$ then $p_1 \geq 0\ \land\ \cdots \land\ p_m \geq 0 \ \models\ p \geq 0$.
   - If $S$ compact and $M$ is Archimedean, then $p_1 \geq 0\ \land\ \cdots\ \land\ p_m \geq 0 \models p > 0$ then $p \in M$.

## Positivstellensatz to Semi-Definite Programming

__Problem:__ prove the following entailment.
  
  $$p_1 \geq 0\ \land\ \cdots\ \land\ p_m \geq 0\ \models\ p \geq 0 $$ 

__Strategy:__ Find, $\sigma_0, \ldots, \sigma_m$ such that 

$$p = \sigma_0 + \sum_{j=1}^m \sigma_j p_j,\ \text{and}\ \sigma_j\ \mathsf{SOS}$$

  - Bound the degrees of $\sigma_0, \ldots, \sigma_m \in \Re_{2d}[\vec{x}]$.

## Reduction to SDP

 - Fix a basis of monomials $\mu(\vec{x})$.
 - $\sigma_i = \mu^t X_i \mu$
 - $p = \sigma_0 + \sum_{j=1}^m \sigma_j p_j$
   - Equate monomials on LHS and RHS.
   - $\sum_{j=0}^m (P_{i,j}, X_j) = c_{i}$ 
 - Place $X_1, \ldots, X_n$ in a block diagonal form.

    $$ X = \left[ \begin{array}{cccc}
    X_1 & 0 & \cdots & 0 \\ 
    0 & X_2 & \cdots & 0 \\ 
    \vdots & \vdots & \ddots & 0 \\ 
    0 & 0 & \cdots & X_n \\
  \end{array}\right]$$

## Sum Of Squares: Difficulties 

- Positivstellensatz tend to yield SDP instances that often fail _strict feasibility_.


 - Find a polynomial $p  \in \Re[x,y]$ such that 
   - $p(\vec{0}) = 0$.
   - $p$ is SOS.
   - $(x^2 + y^2 \leq 1)\ \models\ p \leq 1$ 

---    
$$p = a_0 + a_1 x + a_2 y + a_3 x^2 + a_4 xy + a_5 y^2 $$
  
- $p(0) = 0$ means that $a_0 = 0$.

- $p$ must be SOS. 
  - However, this means that $a_1 = 0, a_2 = 0$ also follow immediately.
  - If we do not recognize this, the SDP instance will no longer have strict feasibility. 

- Conversion from SOS to SDP requires pre-processing steps.
  - Reference: L&ouml;fberg, Pre- and Post-Processing Sum-of-Squares Programs in Practice.
  

## Differential Equation Models 

Modeling continuously varying quantities (pressure, temperature, nutrient flow, ..):

__Example__
$$ \begin{array}{l}
  \frac{dx}{dt} = - 0.2 x^2 - 0.2 x + 0.3 y \\ 
  \frac{dy}{dt} = - 0.1 x - 0.2 y + 0.2 xy \\ 
  \end{array}$$

  - $\frac{dx_1}{dt} = f_1(x_1, \ldots, x_n), \ldots, \frac{dx_n}{dt} = f_n(x_1, \ldots, x_n)$.
    - $\frac{d\vec{x}}{dt} = f(\vec{x})$

## Solution

  - Initial condition: $x_1(0), \ldots, x_n(0)$.
  - Function: $\tau:\ \Re \to \Re^n$.
    - $\tau(0) = (x_1(0), \ldots, x_n(0))$
    - $\forall\ t,\ \frac{d\tau}{dt} = f(\tau(t))$

## Proving Safety Properties 

![](figures/safety_example.png){width=80% fig-align="center"}

__Prove__ If $\vec{x}(0)$ in $I$, then $U$ is never reached.

## Barrier Functions 

- Find a Barrier Function $B(x_1, \ldots, x_n)$ for $\epsilon > 0$.

- $\vec{x} \in I\ \models\ B \geq \epsilon$
- $\vec{x} \in U\ \models\ B \leq -\epsilon$
- $B(\vec{x}) = 0\ \models\ \underset{\text{Lie Derivative}}{\underbrace{(\nabla B) \cdot f \geq \epsilon}}$

__Explanation__ in lecture.

## Barrier Functions  Synthesis

\newcommand\vx{\vec{x}}

Inputs: 

- ODE model: $\frac{d\vx}{dt} = f(\vx)$
- Initial Set: $g_1(\vx) \geq 0\ \land\ \cdots\ \land\ g_k(\vx) \geq 0$
- Unsafe Set: $h_1(\vx) \geq 0\ \land\ \cdots\ \land\ h_m(\vx) \geq 0$

Goal: Find a barrier given a _template_ (_ansatz_).

$$\sum_{\alpha} c_{\alpha} \vx^{\alpha}$$


Ref. Prajna and Jadbabaie, HSCC 2004.  Also see monograph: "Positive Polynomials in Control".

## Barrier Function Synthesis 

Use positivstellensatz to encode conditions on unknown $c_{\alpha}$.

 - $g_1(\vx) \geq 0\ \land\ \cdots\ \land\ g_k(\vx) \geq 0 \ \models\ B(\vx; c) \geq \epsilon$
 - $h_1(\vx) \geq 0\ \land\ \cdots\ \land\ h_m(\vx) \geq 0\ \models\ -\epsilon - B(\vx; c)  \geq 0$

Encoding the barrier condition:
 $$B(\vec{x}) = 0\ \models\ (\nabla B) \cdot f \geq \epsilon$$

Yields a _bilinear_ SDP (much harder to solve).

## Barrier Function Synthesis  (Continued)

- Exponential Barrier Condition 

$$ \forall\ \vx \in \Re^n,\ (\nabla B) \cdot f \geq - \lambda B$$

- Kong et al, Exponential-Condition-Based Barrier Certificate Generation for Safety Verification of Hybrid Systems, CAV 2013.

## Barrier Synthesis (Demo)

Over to Jupyter notebook


## Polynomial Optimization Problems 

- Unconstrained $\min p(x_1, \ldots, x_n)$

- Constrained 

$$\begin{array}{rl}
\min & p (x_1, \ldots, x_n)\\ 
\mathsf{s.t.} & p_1(x_1, \ldots, x_n ) \geq 0 \\ 
& \vdots \\ 
& p_m(x_1, \ldots, x_n ) \geq 0 \\ 
\end{array}$$

## Finding Bounds on Optima


$$\begin{array}{rl}
\min & p (x_1, \ldots, x_n)\\ 
\mathsf{s.t.} & p_1(x_1, \ldots, x_n ) \geq 0 \\ 
& \vdots \\ 
& p_m(x_1, \ldots, x_n ) \geq 0 \\ 
\end{array}$$

- Find largest $\gamma$ such that 

$$p_1 \geq 0 \land\ \cdots \land p_m \geq 0 \ \models\ p \geq \gamma $$

- $\gamma$ will be a lower bound to true optimal value $\gamma^*$.


## Stability Analysis 

Stability is a fundamental property of dynamical systems.
  - Very important in engineering applications.

Inputs: 

- ODE model: $\frac{d\vx}{dt} = f(\vx)$
- Equilibrium: $\vx^*$ s.t. $f(\vx^*) = 0$.

__Prove:__ $\vx^*$ is a _globally asymptotically stable_ equilibrium.

In lecture, explain stability notions.

## Lyapunov Functions 

Find $V(x_1, \ldots, x_n)$ such that 

  -  $V(x_1, \ldots, x_n)$ is positive definite.
  - $\nabla V \cdot f(x_1, \ldots, x_n)$ is negative definite. 

Using SOS to find stability proofs. 

Ref. Papachristadoulou and Prajna, CDC 2002. 

__Over to Demo__

## Dealing with Floating Point Issues

Numerical instability issues can be serious.

- John Harrison, Verifying Nonlinear Real Formulas Via Sums of Squares, TPHOLS 2007.
- A. Platzer et al., Real-World Verification, CADE 2009.
- Monniaux et al, On the Generation of Positivstellensatz Witnesses in Degenerate Cases.
- Roux, Voronin, Sank., Validating Numerical Semidefinite Programming Solvers for Polynomial Invariants, SAS 2017 and STTT 2019.

## Diagonally Dominant SOS 

Replace Positivesemidefiniteness by diagonal dominance conditions.

- Ref. Ali Ahmadi et al, DSOS and SDSOS.


## Research Horizons

  - Dealing with trigonometric functions.
    - In general, this is undecidable.
    - But restricted cases can be decidable.

  - Approximating trigonometric functions by polynomials.
    - Somewhat standard approach.
    - Can be very challenging to prove properties.

  - Using SOS to prove properties of neural networks.
    - Fazlyab, Pappas and Morari
    - Works by Peter Seiler and Murat Arcak.

## Concluding Remarks

  Thank you!!
